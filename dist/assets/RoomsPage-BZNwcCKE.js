var L=Object.defineProperty;var P=(d,e,t)=>e in d?L(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var l=(d,e,t)=>P(d,typeof e!="symbol"?e+"":e,t);import{_ as x,a as D}from"./phone-XeyzPViJ.js";import{d as S,m as W,r as u,o as M,i as O,j as b,c as R,a as c,p as w,q as k,f as E,g as B,F as I,R as H}from"./index-ByIF6zXJ.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $="/assets/mic.png";class j{constructor(e,t){l(this,"url");l(this,"socket");l(this,"handlers",new Map);l(this,"token");this.url=e,this.token=t}async start(){this.socket=new WebSocket(`${this.url}?access-token=${this.token}`),this.setupListeners()}setupListeners(){var e,t,n;(e=this.socket)==null||e.addEventListener("open",()=>{console.log("WebSocket подключен")}),(t=this.socket)==null||t.addEventListener("message",s=>{try{const o=JSON.parse(s.data.toString()),r=this.handlers.get(o.event);r&&r.forEach(p=>p(o.body))}catch(o){console.error("Ошибка парсинга сообщения:",o)}}),(n=this.socket)==null||n.addEventListener("close",()=>{console.log("WebSocket закрыт")})}on(e,t){var n;this.handlers.has(e)||this.handlers.set(e,[]),(n=this.handlers.get(e))==null||n.push(t)}send(e,t){var s,o;const n={event:e,body:t};((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN?(o=this.socket)==null||o.send(JSON.stringify(n)):console.warn("Сокет не открыт:",e)}close(){var e;(e=this.socket)==null||e.close()}}const y={sdpSemantics:"unified-plan",iceServers:[{urls:"turn:fr-turn2.xirsys.com:3478?transport=udp",username:"b_x8c3H9otu8vC-LwmnAsPdEQnWlh_zHf54JGX8KJx2wBztiX1udhli1_MK6sxHMAAAAAGcuKjdMdWt1cw==",credential:"c8628fa0-9de3-11ef-a83d-0242ac120004"}],encodedInsertabelStream:!0};class J{constructor(e,t,n){l(this,"peerConnections",new Map);l(this,"signalingClient");l(this,"localStream");l(this,"createVideoElement");l(this,"pendingCandidates",[]);this.signalingClient=t,this.localStream=e,this.registerSocketHandlers(),this.createVideoElement=n}addRemoteParticipant(e,t){const n=new RTCPeerConnection(y);this.peerConnections.set(e,n),this.localStream.getTracks().forEach(s=>{n.addTrack(s,this.localStream)}),this.setupPeerConnection(n,e,t),this.createOfferAndSend(e)}setupPeerConnection(e,t,n){e.ontrack=s=>{s.streams[0]&&(n.srcObject=s.streams[0])},e.onicecandidate=s=>{s.candidate&&(console.log("send icecandidate"),this.signalingClient.send("ice-candidate",{to:t,data:s.candidate}))},e.onconnectionstatechange=()=>{e.connectionState==="connected"&&console.log(`Соединение с ${t} установлено`)}}createOfferAndSend(e){const t=this.peerConnections.get(e);t&&t.createOffer().then(n=>t.setLocalDescription(n)).then(()=>{this.signalingClient.send("offer",{to:e,data:t.localDescription}),console.log("offer send")}).catch(n=>console.error("Ошибка при создании offer:",n))}registerSocketHandlers(){this.signalingClient.on("offer",async({from:e,data:t})=>{console.log("offer emit");const n=e;let s=this.peerConnections.get(n);if(!s){s=new RTCPeerConnection(y),this.peerConnections.set(n,s);var o=this.createVideoElement(e);this.setupPeerConnection(s,n,o)}await s.setRemoteDescription(new RTCSessionDescription(t));const r=await s.createAnswer();await s.setLocalDescription(r),this.signalingClient.send("answer",{to:n,data:r}),console.log("answer send")}),this.signalingClient.on("answer",async({from:e,data:t})=>{const n=e,s=this.peerConnections.get(n);if(s){await s.setRemoteDescription(new RTCSessionDescription(t));for(const o of this.pendingCandidates)await s.addIceCandidate(o);this.pendingCandidates=[]}}),this.signalingClient.on("ice-candidate",async({from:e,data:t})=>{console.log("ice emit");const n=e,s=this.peerConnections.get(n);if(s&&s.remoteDescription)try{await s.addIceCandidate(t)}catch(o){console.warn("Не удалось добавить ICE кандидата:",o)}else this.pendingCandidates.push(t)})}}const z={class:"videos"},F={id:"controls"},K={href:"lobby.html"},q=S({__name:"SignalingTestWidget",setup(d){const e=new H("https://dotflopp.ru/api"),t=W(),n=u(null),s=u(null),o=u(null),r=u(null);let p,g,m=u(null),C=u(null),h=null;M(async()=>{const i=await e.connectionToVoiceChannel(t.getActiveChannel);console.log(i.token),h=new j("wss://dotflopp.ru/signaling",i.token),await T(),await h.start()});async function T(){var i,a;n.value!=null&&(g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),n.value.srcObject=g,p=new J(g,h,_),h.on("userInChannel",async({data:f})=>{console.log(f),f&&f.forEach(v=>{console.log(v),p.addRemoteParticipant(v,_())})}),(i=o==null?void 0:o.value)==null||i.addEventListener("click",A),(a=r==null?void 0:r.value)==null||a.addEventListener("click",V))}function _(i){return s.value}async function A(){let i=g.getTracks().find(a=>a.kind==="video");i.enabled?(i.enabled=!1,m.value={backgroundColor:"rgb(255, 80, 80)"}):(i.enabled=!0,m.value={backgroundColor:"rgb(179, 102, 249, .9)"})}async function V(){let i=g.getTracks().find(a=>a.kind==="audio");i.enabled?(i.enabled=!1,C.value={backgroundColor:"rgb(255, 80, 80)"}):(i.enabled=!0,C.value={backgroundColor:"rgb(179, 102, 249, .9)"})}return(i,a)=>{const f=O("router-link");return b(),R(I,null,[c("div",z,[c("video",{ref_key:"localVideoRef",ref:n,class:"video-player smallFrame",autoplay:"",playsinline:""},null,512),c("video",{ref_key:"remoteVideoRef",ref:s,class:"video-player",autoplay:"",playsinline:""},null,512)]),c("div",F,[c("div",{ref_key:"cameraRef",ref:o,class:"control-container",id:"camera-btn",style:w(k(m))},a[0]||(a[0]=[c("img",{src:x},null,-1)]),4),c("div",{ref_key:"micRef",ref:r,class:"control-container",id:"mic-btn",style:w(k(C))},a[1]||(a[1]=[c("img",{src:$},null,-1)]),4),c("a",K,[E(f,{to:"/main"},{default:B(()=>a[2]||(a[2]=[c("div",{class:"control-container",id:"leave-btn"},[c("img",{src:D})],-1)])),_:1})])])],64)}}}),G=N(q,[["__scopeId","data-v-991b0e18"]]),Z=S({__name:"RoomsPage",setup(d){return(e,t)=>(b(),R("div",null,[E(k(G))]))}});export{Z as default};
