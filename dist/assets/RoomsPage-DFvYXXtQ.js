var x=Object.defineProperty;var L=(l,e,t)=>e in l?x(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var r=(l,e,t)=>L(l,typeof e!="symbol"?e+"":e,t);import{_ as P,a as D}from"./phone-XeyzPViJ.js";import{d as y,m as V,r as p,o as W,i as M,j as S,c as b,a as c,p as _,q as k,f as E,g as O,F as B,R as I}from"./index-CNDI3ltj.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $="/assets/mic.png";class H{constructor(e,t){r(this,"url");r(this,"socket");r(this,"handlers",new Map);r(this,"token");this.url=e,this.token=t}async start(){this.socket=new WebSocket(`${this.url}?access-token=${this.token}`),this.setupListeners()}setupListeners(){var e,t,n;(e=this.socket)==null||e.addEventListener("open",()=>{console.log("WebSocket подключен")}),(t=this.socket)==null||t.addEventListener("message",s=>{try{const i=JSON.parse(s.data.toString()),d=this.handlers.get(i.event);d&&d.forEach(u=>u(i.body))}catch(i){console.error("Ошибка парсинга сообщения:",i)}}),(n=this.socket)==null||n.addEventListener("close",()=>{console.log("WebSocket закрыт")})}on(e,t){var n;this.handlers.has(e)||this.handlers.set(e,[]),(n=this.handlers.get(e))==null||n.push(t)}send(e,t){var s,i;const n={event:e,body:t};((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN?(i=this.socket)==null||i.send(JSON.stringify(n)):console.warn("Сокет не открыт:",e)}close(){var e;(e=this.socket)==null||e.close()}}const w={sdpSemantics:"unified-plan",iceServers:[{urls:"turn:fr-turn2.xirsys.com:3478?transport=udp",username:"b_x8c3H9otu8vC-LwmnAsPdEQnWlh_zHf54JGX8KJx2wBztiX1udhli1_MK6sxHMAAAAAGcuKjdMdWt1cw==",credential:"c8628fa0-9de3-11ef-a83d-0242ac120004"}],encodedInsertabelStream:!0};class j{constructor(e,t,n){r(this,"peerConnections",new Map);r(this,"signalingClient");r(this,"localStream");r(this,"createVideoElement");r(this,"pendingCandidates",[]);this.signalingClient=t,this.localStream=e,this.registerSocketHandlers(),this.createVideoElement=n}addRemoteParticipant(e,t){const n=new RTCPeerConnection(w);this.peerConnections.set(e,n),this.localStream.getTracks().forEach(s=>{n.addTrack(s,this.localStream)}),this.setupPeerConnection(n,e,t),this.createOfferAndSend(e)}setupPeerConnection(e,t,n){e.ontrack=s=>{s.streams[0]&&(n.srcObject=s.streams[0])},e.onicecandidate=s=>{s.candidate&&(console.log("send icecandidate"),this.signalingClient.send("ice-candidate",{to:t,data:s.candidate}))},e.onconnectionstatechange=()=>{e.connectionState==="connected"&&console.log(`Соединение с ${t} установлено`)}}createOfferAndSend(e){const t=this.peerConnections.get(e);t&&t.createOffer().then(n=>t.setLocalDescription(n)).then(()=>{this.signalingClient.send("offer",{to:e,data:t.localDescription}),console.log("offer send")}).catch(n=>console.error("Ошибка при создании offer:",n))}registerSocketHandlers(){this.signalingClient.on("offer",async({from:e,data:t})=>{console.log("offer emit");const n=e;console.log(n);let s=this.peerConnections.get(n);if(!s){s=new RTCPeerConnection(w),this.peerConnections.set(n,s);var i=this.createVideoElement(e);this.setupPeerConnection(s,n,i)}await s.setRemoteDescription(new RTCSessionDescription(t));const d=await s.createAnswer();await s.setLocalDescription(d),this.signalingClient.send("answer",{to:n,data:d}),console.log("answer send")}),this.signalingClient.on("answer",async({from:e,data:t})=>{const n=e,s=this.peerConnections.get(n);if(s){await s.setRemoteDescription(new RTCSessionDescription(t));for(const i of this.pendingCandidates)await s.addIceCandidate(i);this.pendingCandidates=[]}}),this.signalingClient.on("ice-candidate",async({from:e,data:t})=>{console.log("ice emit");const n=e,s=this.peerConnections.get(n);if(s&&s.remoteDescription)try{await s.addIceCandidate(t)}catch(i){console.warn("Не удалось добавить ICE кандидата:",i)}else this.pendingCandidates.push(t)})}}const J={class:"videos"},z={id:"controls"},F={href:"lobby.html"},K=y({__name:"SignalingTestWidget",setup(l){const e=new I("https://dotflopp.ru/api"),t=V(),n=p(null);p(null);const s=p(null),i=p(null);let d,u,m=p(null),h=p(null),f=null;W(async()=>{const a=await e.connectionToVoiceChannel(t.getActiveChannel);console.log(a.token),f=new H("wss://dotflopp.ru/signaling",a.token),await R(),await f.start()});async function R(){var a,o;n.value!=null&&(u=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),n.value.srcObject=u,d=new j(u,f,v),f.on("userInChannel",async({data:g})=>{console.log(g),g&&g.forEach(C=>{console.log(C),d.addRemoteParticipant(C,v(C))})}),(a=s==null?void 0:s.value)==null||a.addEventListener("click",T),(o=i==null?void 0:i.value)==null||o.addEventListener("click",A))}function v(a){const o=document.createElement("video");o.autoplay=!0,o.playsInline=!0,o.className="video-player remote-video",o.id=`video-${a}`,o.style.width="300px",o.style.height="200px";const g=document.getElementById("remote-videos-container");return g&&g.appendChild(o),o}async function T(){let a=u.getTracks().find(o=>o.kind==="video");a.enabled?(a.enabled=!1,m.value={backgroundColor:"rgb(255, 80, 80)"}):(a.enabled=!0,m.value={backgroundColor:"rgb(179, 102, 249, .9)"})}async function A(){let a=u.getTracks().find(o=>o.kind==="audio");a.enabled?(a.enabled=!1,h.value={backgroundColor:"rgb(255, 80, 80)"}):(a.enabled=!0,h.value={backgroundColor:"rgb(179, 102, 249, .9)"})}return(a,o)=>{const g=M("router-link");return S(),b(B,null,[c("div",J,[c("video",{ref_key:"localVideoRef",ref:n,class:"video-player smallFrame",autoplay:"",playsinline:""},null,512),o[0]||(o[0]=c("div",{id:"remote-videos-container"},null,-1))]),c("div",z,[c("div",{ref_key:"cameraRef",ref:s,class:"control-container",id:"camera-btn",style:_(k(m))},o[1]||(o[1]=[c("img",{src:P},null,-1)]),4),c("div",{ref_key:"micRef",ref:i,class:"control-container",id:"mic-btn",style:_(k(h))},o[2]||(o[2]=[c("img",{src:$},null,-1)]),4),c("a",F,[E(g,{to:"/main"},{default:O(()=>o[3]||(o[3]=[c("div",{class:"control-container",id:"leave-btn"},[c("img",{src:D})],-1)])),_:1})])])],64)}}}),q=N(K,[["__scopeId","data-v-63accf03"]]),Y=y({__name:"RoomsPage",setup(l){return(e,t)=>(S(),b("div",null,[E(k(q))]))}});export{Y as default};
