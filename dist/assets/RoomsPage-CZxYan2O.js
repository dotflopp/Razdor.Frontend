var b=Object.defineProperty;var E=(l,e,n)=>e in l?b(l,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[e]=n;var s=(l,e,n)=>E(l,typeof e!="symbol"?e+"":e,n);import{_ as L,a as R}from"./phone-XeyzPViJ.js";import{d as f,r as g,o as T,i as x,j as m,c as v,a as r,m as C,p as u,f as k,g as A,F as W}from"./index-B1-YJayX.js";const D="/assets/mic.png";class I{constructor(e){s(this,"url");s(this,"socket");s(this,"handlers",new Map);this.url=e}async start(){this.socket=new WebSocket(this.url),this.setupListeners()}setupListeners(){var e,n,t;(e=this.socket)==null||e.addEventListener("open",()=>{console.log("WebSocket подключен")}),(n=this.socket)==null||n.addEventListener("message",c=>{try{const i=JSON.parse(c.data.toString()),d=this.handlers.get(i.event);d&&d.forEach(h=>h(i.data))}catch(i){console.error("Ошибка парсинга сообщения:",i)}}),(t=this.socket)==null||t.addEventListener("close",()=>{console.log("WebSocket закрыт")})}on(e,n){var t;this.handlers.has(e)||this.handlers.set(e,[]),(t=this.handlers.get(e))==null||t.push(n)}send(e,n){var c,i;const t={event:e,data:n};((c=this.socket)==null?void 0:c.readyState)===WebSocket.OPEN?(i=this.socket)==null||i.send(JSON.stringify(t)):console.warn("Сокет не открыт:",e)}close(){var e;(e=this.socket)==null||e.close()}}const M={sdpSemantics:"unified-plan",iceServers:[{urls:"turn:fr-turn2.xirsys.com:3478?transport=udp",username:"b_x8c3H9otu8vC-LwmnAsPdEQnWlh_zHf54JGX8KJx2wBztiX1udhli1_MK6sxHMAAAAAGcuKjdMdWt1cw==",credential:"c8628fa0-9de3-11ef-a83d-0242ac120004"}],encodedInsertabelStream:!0};class O{constructor(e){s(this,"peerConnection");s(this,"signalingClient");s(this,"localStream");s(this,"pendingCandidates",[]);s(this,"createPeerConnection",async e=>{await this.signalingClient.start(),this.peerConnection.ontrack=n=>{const t=n.streams[0];e.srcObject=t},this.peerConnection.onicecandidate=this.handleICECandidateEvent,this.peerConnection.onconnectionstatechange=this.handleSignalingSateEvent,this.peerConnection.onicegatheringstatechange=this.handleIceConnectionStateChangeEvent});s(this,"handleIceConnectionStateChangeEvent",e=>{});s(this,"handleSignalingSateEvent",e=>{this.peerConnection.iceConnectionState==="connected"&&this.peerConnection.getStats()});s(this,"handleICECandidateEvent",e=>{e.candidate&&this.signalingClient.send("ice-candidate",e.candidate)});s(this,"registerSocketHandlers",()=>{this.signalingClient.on("offer",async e=>{console.log("emit offer from another peer"),console.log(e);const n=new RTCSessionDescription(e.offer);await this.peerConnection.setRemoteDescription(n);const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t),this.signalingClient.send("answer",t),console.log("send answer")}),this.signalingClient.on("answer",async e=>{console.log("emit answer from another peer"),await this.peerConnection.setRemoteDescription(e),console.log("Обмен закончен");for(const n of this.pendingCandidates)console.log(n),await this.peerConnection.addIceCandidate(n);this.pendingCandidates=[]}),this.signalingClient.on("ice-candidate",async e=>{e&&(this.peerConnection.remoteDescription?(console.log(e),await this.peerConnection.addIceCandidate(e)):(this.pendingCandidates.push(e),console.log("сохраняем в очередь")))}),this.signalingClient.on("end-call",async()=>{this.endCall()})});s(this,"startCall",async()=>{const e=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(e),await this.signalingClient.send("offer",{offer:e}),console.log("send Offer from startCall")});s(this,"endCall",async()=>{this.peerConnection&&this.peerConnection.close()});this.signalingClient=new I("ws://localhost:3000"),this.peerConnection=new RTCPeerConnection(M),this.localStream=e,this.localStream.getTracks().forEach(n=>{this.peerConnection.addTrack(n,e)}),this.registerSocketHandlers()}}const B={class:"videos"},P={id:"controls"},V={href:"lobby.html"},H=f({__name:"SignalingTestWidget",setup(l){let e=g(null),n=g(null),t=g(null),c=g(null),i,d,h=g(null),p=g(null),_=async()=>{var a,o;e.value!=null&&(i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),e.value.srcObject=i,d=new O(i),await d.createPeerConnection(n.value),await d.startCall(),(a=t==null?void 0:t.value)==null||a.addEventListener("click",S),(o=c==null?void 0:c.value)==null||o.addEventListener("click",y))},S=async()=>{let a=i.getTracks().find(o=>o.kind==="video");a.enabled?(a.enabled=!1,h.value={backgroundColor:"rgb(255, 80, 80)"}):(a.enabled=!0,h.value={backgroundColor:"rgb(179, 102, 249, .9)"})},y=async()=>{let a=i.getTracks().find(o=>o.kind==="audio");a.enabled?(a.enabled=!1,p.value={backgroundColor:"rgb(255, 80, 80)"}):(a.enabled=!0,p.value={backgroundColor:"rgb(179, 102, 249, .9)"})};return T(_),(a,o)=>{const w=x("router-link");return m(),v(W,null,[r("div",B,[r("video",{ref_key:"localVideoRef",ref:e,class:"video-player smallFrame",autoplay:"",playsinline:""},null,512),r("video",{ref_key:"remoteVideoRef",ref:n,class:"video-player",autoplay:"",playsinline:""},null,512)]),r("div",P,[r("div",{ref_key:"cameraRef",ref:t,class:"control-container",id:"camera-btn",style:C(u(h))},o[0]||(o[0]=[r("img",{src:L},null,-1)]),4),r("div",{ref_key:"micRef",ref:c,class:"control-container",id:"mic-btn",style:C(u(p))},o[1]||(o[1]=[r("img",{src:D},null,-1)]),4),r("a",V,[k(w,{to:"/main"},{default:A(()=>o[2]||(o[2]=[r("div",{class:"control-container",id:"leave-btn"},[r("img",{src:R})],-1)])),_:1})])])],64)}}}),z=f({__name:"RoomsPage",setup(l){return(e,n)=>(m(),v("div",null,[k(u(H))]))}});export{z as default};
